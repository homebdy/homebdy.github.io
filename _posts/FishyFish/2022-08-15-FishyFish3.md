---
layout: post
title:  "[Fishy Fish] Backend - ë©”ì¸í˜ì´ì§€"
author: yj
category: [ Fishy Fish ğŸ£ ]
tags: [ Python, Backend, Fishy Fish ]
---
### ë©”ì¸ í˜ì´ì§€ API Flow ì •ë¦¬
1. ì‚¬ìš©ìê°€ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ í•œë‹¤.
2. ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë¥¼ S3ë²„í‚·ì— ì €ì¥í•œ í›„ ì´ë¯¸ì§€ urlì„ ë°˜í™˜ë°›ëŠ”ë‹¤.
3. ë°˜í™˜ëœ urlì„ rabbitMQì— ì „ë‹¬í•˜ì—¬ Celery Workerì— ì „ë‹¬í•˜ì—¬ ë¬¼ê³ ê¸° ì¢… ë¶„ë¥˜ë¥¼ í•œë‹¤.
4. ë¶„ë¥˜í•œ ê²°ê³¼ê°’ì„ í†µí•´ DBì— ì´ˆê¸°ë°ì´í„°ë¡œ ì„¸íŒ…ë˜ì–´ ìˆëŠ” ë¬¼ê³ ê¸° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤.
5. ì‚¬ìš©ìì—ê²Œ ë¬¼ê³ ê¸° ì •ë³´ ë°˜í™˜

#### ì½”ë“œ ì‘ì„± ì¤‘ ë°œìƒí•œ ë¬¸ì œë“¤
**1. ì´ë¯¸ì§€ë¥¼ adminì—ì„œ ë¯¸ë¦¬ í•œ ì¥ ì €ì¥ì¢‹ì§€ ì•Šìœ¼ë©´ s3ë²„ì¼“ì— ì´ë¯¸ì§€ê°€ ì˜¬ë¼ê°€ì§€ ì•ŠëŠ”ë‹¤..**

- ì›ì¸: imagesì•±ê³¼ accountì•±ì— ê°ì ë§Œë“¤ì–´ë†“ì€ model<br/>

íšŒì›ê°€ì…ì„ í–ˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³  imageëª¨ë¸ì˜ ì™¸ë˜í‚¤ë¡œ ì¡´ì¬í•˜ëŠ” user_idê°€ ì¸ì‹ë˜ì§€ ì•ŠëŠ” ê²ƒì„ admin í…ŒìŠ¤íŠ¸ ì¤‘ í™•ì¸í–ˆë‹¤.<br/>
ë”°ë¼ì„œ ê°ì ì‘ì„±í•´ë†“ì€ ORMì„ í”„ë¡œì íŠ¸ í´ë”ì— í•©ì³¤ë‹¤.<br/>

âˆ´ ë¬¸ì œ í•´ê²°
<br/><br/>

**2. ì´ë¯¸ ì €ì¥í–ˆë˜ ì´ë¯¸ì§€ì™€ ê°™ì€ ì´ë¦„ì˜ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ë©´ ì´ì „ì— ì €ì¥í–ˆë˜ ì´ë¯¸ì§€ê°€ s3ë²„ì¼“ì—ì„œ ì‚¬ë¼ì§„ë‹¤..**

- íŒŒì¼ ì´ë¦„ì„ UUIDë¡œ ë®ì–´ì“°ê¸°í•œ í›„ ì´ë¯¸ì§€ë¥¼ ì €ì¥í–ˆë‹¤.

âˆ´ ë¬¸ì œ í•´ê²°

#### ì „ì²´ ì½”ë“œ
```python
class imageView(APIView):
    # ì´ë¯¸ì§€ ì—…ë¡œë“œ
    def post(self, request):
        user_token = jwt.decode(request.COOKIES.get("access"), get_secret("SECRET_KEY"), algorithms=['HS256'])
        userId = user_token['user_id']
        if userId is None:
            return Response({"message":"ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."}, status=status.HTTP_400_BAD_REQUEST)
        image = Image()
        image.url = request.FILES.get('uploadImage')
        // íŒŒì¼ ì´ë¦„ uuidë¡œ ë®ì–´ì“°ê¸°
        file_name = str(uuid.uuid4())  
        imageByte = io.BytesIO()
        image_file = PILImage.open(image.url)
        image_file.save(imageByte, 'png')
        imageByte.seek(0)
        result_url = ContentFile(imageByte.read(), f'{file_name}.png')
        image.url = result_url
        image.user_id = userId
        image.save()

        fish_id = fish_ai.delay(image.url.url).get()
        image.fish = Fish.objects.get(id=fish_id)
        image.save()
        fish = image.fish
        content = {
            'url': image.url.url, #ì‚¬ì§„
            'name': fish.name, #ì´ë¦„
            'toxicity':fish.toxicity,
            'prohibit_period': fish.prohibit_period,
            'prohibit_area': fish.prohibit_area,
            'description': fish.description
        }
        return Response(content, status=status.HTTP_201_CREATED)
```